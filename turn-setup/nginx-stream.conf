# =============================================================================
# Nginx Stream Block — L4 TCP Passthrough for TURN/TLS
# =============================================================================
#
# IMPORTANT: This goes in nginx.conf at the TOP LEVEL (same level as 'http'),
# NOT inside the 'http' block. The 'stream' block is a separate context.
#
# nginx.conf structure:
#
#   events { ... }
#
#   stream {
#     # ← paste this content here
#   }
#
#   http {
#     # your existing sites, reverse proxies, etc.
#   }
#
# =============================================================================
#
# How it works:
#   1. Client connects to turns:turn.example.com:443
#   2. DNS resolves turn.example.com to your server IP
#   3. Nginx stream catches TCP traffic on 443 for this SNI hostname
#   4. Nginx passes raw TCP bytes to livekit-turn container on 127.0.0.1:5349
#   5. LiveKit handles TLS termination + TURN protocol inside the container
#
# This is NOT an HTTP proxy — it's raw TCP forwarding (L4).
# Nginx never decrypts the TLS; LiveKit does that with its own certs.
#
# =============================================================================

# Add this block to your nginx.conf (top level, NOT inside http {}):

# stream {
#
#     # Map SNI hostname to decide where to route TCP traffic on port 443
#     map $ssl_preread_server_name $backend {
#         turn.example.com    turn_backend;
#         default             web_backend;
#     }
#
#     # TURN/TLS backend — raw TCP passthrough to LiveKit TURN container
#     upstream turn_backend {
#         server 127.0.0.1:5349;
#     }
#
#     # Regular HTTPS — pass to Nginx's own HTTP handler
#     upstream web_backend {
#         server 127.0.0.1:8443;   # Nginx http block listens here internally
#     }
#
#     # Single listener on 443, routes by SNI hostname
#     server {
#         listen 443;
#         ssl_preread on;           # Read SNI without decrypting
#         proxy_pass $backend;
#     }
#
# }

# =============================================================================
# ALSO: Change your existing Nginx http {} SSL sites to listen on 8443
# internally (instead of 443), since the stream block now owns port 443.
#
# Before:
#   server {
#       listen 443 ssl;
#       server_name app.example.com;
#       ...
#   }
#
# After:
#   server {
#       listen 8443 ssl;            # ← changed from 443
#       server_name app.example.com;
#       ...
#   }
#
# The stream block routes app.example.com → 8443 (your sites)
# and turn.example.com → 5349 (TURN container), all on external port 443.
# =============================================================================
